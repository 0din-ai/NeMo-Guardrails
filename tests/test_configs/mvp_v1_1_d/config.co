# Common

flow user said $text
  match UtteranceUserActionFinished(final_transcript=$text)

flow user says something
  match UtteranceUserActionFinished() as $event

flow bot say $text
  await UtteranceBotAction(script=$text)

flow wait
  await SomeRandomEvent()

# Custom

flow user express greeting
  user said "hi"
    or user said "hello"

flow user provide custom instructions
  user said "do something"

flow bot express greeting
  bot say "Hello world!"

flow bot comment unsure how to respond
  bot say "I'm not sure how to respond."

# This needs to be generated dynamically
#flow user instruction action
#  bot say "Why don't scientists trust atoms? Because they make up everything!"
#  bot say "I'm smiling."

flow greeting
  user express greeting
  bot express greeting

flow user unknown intent
  user said "xyz"


flow fallback
  # user says something as $flow_ref

  # TODO: check why $flow_ref is None here
  # TODO: extract the last user message properly
  # $user_message = "i want stuff"
  #  $event = $flow_ref.event
  #  $user_message = $event.final_transcript
  match UtteranceUserAction().Finished() as $event_ref
  $user_message = $event_ref.arguments.final_transcript
  # $user_message = "i want a joke"

  bot say "User message is"
  bot say $user_message

  $intent = await GenerateUserIntentAction(user_message=$user_message)
  bot say "The intent is"
  bot say $intent

  # TODO: trigger the finishing of the event with the corresponding flow name
  send FinishFlow(flow_id=$intent)

flow unknown intent
  user unknown intent
  bot comment unsure how to respond

flow do $instructions
  $flow_source = await GenerateFlowAction(instructions=$instructions, flow_name="user instruction action")
  await AddFlowsAction(config=$flow_source)
  bot say "bla"

  await user instruction action

flow custom instructions
  user provide custom instructions

  # Extract this in a hardcoded way, for testing.
  $instructions = "I want you to tell a joke and smile."

  do $instructions


flow main
  activate greeting
  activate custom instructions
  activate unknown intent
  activate fallback
  wait
